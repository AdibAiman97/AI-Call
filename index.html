<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Call Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        #app {
            background-color: #1F2937;
            border-radius: 0.75rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 768px;
            height: 90vh;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1.text-white {
            color: white !important;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }


        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }
        .user-message-container {
            align-self: flex-end;
        }
        .ai-message-container {
            align-self: flex-start;
        }


        .message-bubble {
            padding: 0.75rem 1rem;
            line-height: 1.5;
            word-break: break-word;
            flex-shrink: 0;
            margin-top: 0.25rem;
            color: inherit;
        }
        .message-bubble p {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .message-bubble p:last-child {
            margin-bottom: 0;
        }
        .message-bubble ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .message-bubble li {
            margin-bottom: 0.25rem;
        }
        .message-bubble li:last-child {
            margin-bottom: 0;
        }

        .message-bubble li strong:first-child {
            display: inline;
        }

        .user-message {
            background-color: #2EC4B6;
            color: white;
            border-radius: 0.75rem 0.75rem 0.2rem 0.75rem;
            margin-left: auto;
            margin-right: 0.5rem;
        }

        .ai-message {
            background-color: #2D3748; 
            color: #E0E0E0;
            border-radius: 0.75rem 0.75rem 0.75rem 0.2rem;
            margin-right: auto;
            margin-left: 0.5rem;
        }

        .message-label {
            font-size: 0.75rem;
            color: #b0b0b0;
            margin-bottom: 0.25rem;
        }
        .user-label {
            align-self: flex-end;
            margin-right: 0.5rem;
        }
        .ai-label {
            align-self: flex-start;
            margin-left: 0.5rem; 
        }


        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid #4e4e50;
            background-color: #1F2937;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .input-field {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #496fa8;
            border-radius: 0.5rem;
            font-size: 1rem;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
            transition: border-color 0.2s;
            color: rgb(5, 5, 5);
        }
        .input-field:focus {
            border-color: #2EC4B6;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            height: 40px;
        }
        .btn-primary {
            background-color: #2EC4B6;
            color: white;
            box-shadow: 0 4px 10px rgba(46, 196, 182, 0.3);
        }
        .btn-primary:hover {
            background-color: #24A295;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        .typing-indicator-container {
            display: flex;
            align-items: center;
            margin-left: 0.5rem;
            margin-right: auto;
            max-width: 80%;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            height: 1.5em;
            background-color: #2D3748;
            color: #E0E0E0;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem 0.75rem 0.75rem 0.2rem;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #E0E0E0;
            border-radius: 50%;
            opacity: 0;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
                opacity: 0;
            }
            40% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <h1 class="text-2xl font-bold text-center text-white py-4 border-b border-gray-700">
            Voxis AI Call Center
        </h1>

        <div class="chat-messages" ref="messagesContainer">
            <div class="ai-message-container ai-message-bubble">
                <div class="message-label ai-label">AI Agent</div>
                <div class="ai-message message-bubble">
                    Hello! I'm your Voxis AI Call Center Assistant. How can I help you today with your property sales gallery inquiries?
                </div>
            </div>

            <div v-for="(message, index) in messages" :key="index"
                 :class="{ 'user-message-container': message.sender === 'user', 'ai-message-container': message.sender === 'ai' }"
                 class="message-container">
                <div :class="{ 'user-label': message.sender === 'user', 'ai-label': message.sender === 'ai' }" class="message-label">
                    {{ message.sender === 'user' ? 'User' : 'AI Agent' }}
                </div>
                <div :class="{ 'user-message': message.sender === 'user', 'ai-message': message.sender === 'ai' }" class="message-bubble" v-html="renderMessageContent(message.text)"></div>
            </div>

            <div v-if="loading" class="ai-message-container ai-message-bubble">
                <div class="message-label ai-label">AI Agent</div>
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <textarea
                v-model="query"
                @keydown.enter.prevent="sendMessage"
                rows="1"
                class="input-field"
                placeholder="Type your message..."
            ></textarea>
            <button
                @click="sendMessage"
                :disabled="loading || !query.trim()"
                class="btn btn-primary"
            >
                <span v-if="loading" class="loading-spinner"></span>
                <span v-else>Send</span>
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, nextTick, onMounted } = Vue; 
        
        createApp({
            setup() {
                const query = ref('');
                const messages = ref([]); 
                const loading = ref(false);
                const backendUrl = 'http://127.0.0.1:8000/query';             
                const messagesContainer = ref(null); 
                const sessionId = ref(null); 

                const synth = window.speechSynthesis;
                const scrollToBottom = () => {
                    nextTick(() => {
                        if (messagesContainer.value) {
                            messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight;
                        }
                    });
                };

                // Function to generate a simple UUID-like string
                const generateUUID = () => {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                };

                // Generate session ID on component mount
                onMounted(() => {
                    if (!sessionId.value) { 
                        sessionId.value = localStorage.getItem('chatSessionId') || generateUUID();
                        localStorage.setItem('chatSessionId', sessionId.value);
                        console.log("Session ID initialized:", sessionId.value);
                    }
                });


                const speakText = (text) => {
                    if (synth.speaking) {
                        synth.cancel(); 
                    }
                    const utterance = new SpeechSynthesisUtterance(text);
                    synth.speak(utterance);
                };

                const renderMessageContent = (text) => {
                    let html = '';
                    const lines = text.split('\n');
                    let inList = false;

                    lines.forEach(line => {
                        line = line.trim();
                        line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        line = line.replace(/__(.*?)__/g, '<strong>$1</strong>');

                        if (line.startsWith('* ') || line.startsWith('- ')) {
                            if (!inList) {
                                html += '<ul>';
                                inList = true;
                            }
                            let listItemContent = line.substring(2).trim();
                            html += `<li>${listItemContent}</li>`;
                        } else {
                            if (inList) {
                                html += '</ul>';
                                inList = false;
                            }
                            // Add paragraph tag for non-list content. 
                            if (line) {
                                html += `<p>${line}</p>`;
                            } else { 
                                html += '<br>';
                            }
                        }
                    });

                    if (inList) {
                        html += '</ul>';
                    }
                    
                    html = html.replace(/<p><br><\/p>/g, '<br>').replace(/<p>\s*<\/p>/g, '');

                    return html;
                };

                const sendMessage = async () => {
                    const userQuery = query.value.trim();
                    if (!userQuery) {
                        return;
                    }

                    messages.value.push({ sender: 'user', text: userQuery });
                    query.value = '';
                    scrollToBottom();

                    loading.value = true;

                    try {
          
                        const historyForBackend = messages.value.filter(msg => 
                            msg.sender === 'user' || msg.sender === 'ai'
                        ).map(msg => ({
                            role: msg.sender, 
                            text: msg.text
                        }));

                        const res = await fetch(backendUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
    
                            body: JSON.stringify({ 
                                query: userQuery,
                                history: historyForBackend,
                                session_id: sessionId.value 
                            }),
                        });

                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }

                        const data = await res.json();
                        const aiResponse = data.response || "No response received.";
                        messages.value.push({ sender: 'ai', text: aiResponse }); 
                        
                        speakText(aiResponse);

                    } catch (error) {
                        console.error("Error sending message:", error);
                        messages.value.push({ sender: 'ai', text: "Failed to connect or an error occurred: " + error.message });
                    } finally {
                        loading.value = false;
                        scrollToBottom();
                    }
                };

                return {
                    query,
                    messages,
                    loading,
                    sendMessage,
                    messagesContainer,
                    renderMessageContent
                };
            }
        }).mount('#app');
    </script>
</body>
</html>